import requests
import datetime
import time

# –§—É–Ω–∫—Ü–∏–∏, –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–µ –≤ —Ä–∞–±–æ—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–æ–≤–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –¢–µ–ª–µ–≥—Ä–∞–º
# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞, —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –∏–¥ –ø–æ—Å—Ç–∞, –∏–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –¥–∞—Ç–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
def tg_message(chat_id, group, post_id, com_id, com_text, com_date, token):
    com_date = datetime.datetime.utcfromtimestamp(com_date + 10800).strftime('%Y-%m-%d %H:%M:%S')
    url = 'https://vk.com/wall{group}_{post_id}?w=wall{group}_{post_id}_r{com_id}'.format(group=group, post_id=post_id,
                                                                                          com_id=com_id)
    message = 'üÜò –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ!\n‚û° –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:\n{}\n‚û° –°—Å—ã–ª–∫–∞:\n{}\n‚û° –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {}'.format(
        com_text, url, com_date)
    tg = requests.get(f'https://api.telegram.org/bot{token}/sendMessage',
                      params={'chat_id': chat_id, 'text': message})

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º
def tg_message_test(chat_id, token):
    try:
        message = '–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º-—á–∞—Ç!'
        tg = requests.get(f'https://api.telegram.org/bot{token}/sendMessage',
                          params={'chat_id': chat_id, 'text': message})
        print('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç')
    except Exception:
        print('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.')

# –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ f,f1, data –Ω–µ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –¥–∞–Ω–Ω–æ–º –º–æ–¥—É–ª–µ
def vk_parsing(MONITORING_GROUPS, TOKEN_VK, CHAT_ID_TG, TOKEN_TG):

    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç), –≥–¥–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
    f = open('all_comments.txt', 'r+', encoding='utf-8')
    data = f.read().splitlines()

    # –°–æ–∑–¥–∞–µ–º (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) –ª–æ–≥-—Ñ–∞–π–ª
    f1 = open('comtotg.log', 'a', encoding='utf-8')

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    now = datetime.datetime.now()

    # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥
    f1.write('–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω ' + now.strftime('%d-%m-%Y %H:%M') + '\n')

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä—â–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    try:
        for group in MONITORING_GROUPS:

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –ø–æ—Å—Ç–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            group_posts = requests.get('https://api.vk.com/method/wall.get',
                                       params={'owner_id': group, 'access_token': TOKEN_VK, 'v': '5.81',
                                               'count': 100, 'offset': 0, 'filter': 'owner'})
            k = group_posts.json()

            # –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –º–µ–Ω–µ–µ 100 –ø—É–±–ª–∏–∫–∞—Ü–∏–π
            if k['response']['count'] < 100:
                posts = k['response']['count']
            else:
                posts = 100

            post_number = 0

            # –ü–æ–∫–∞ –Ω–æ–º–µ—Ä —Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –º–µ–Ω—å—à–µ 100 (–∏–ª–∏ –º–µ–Ω—å—à–µ –∫–æ–ª-–≤–∞ –ø–æ—Å—Ç–æ–≤ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ, –µ—Å–ª–∏ –∏—Ö –º–µ–Ω—å—à–µ 100)
            while post_number < posts:

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞
                if k['response']['items'][post_number]['comments']['count'] != 0:
                    print(k['response']['items'][post_number]['comments']['count'])

                    # –ü–æ–ª—É—á–∞–µ–º id —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞
                    post_id = k['response']['items'][post_number]['id']

                    # –ü–∞—É–∑–∞ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å API –í–ö
                    time.sleep(0.9)

                    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞
                    post_comments = requests.get('https://api.vk.com/method/wall.getComments',
                                                 params={'owner_id': group, 'post_id': post_id, 'access_token': TOKEN_VK,
                                                         'v': '5.81', 'count': 100, 'offset': 0, 'filter': 'owner'})

                    k1 = post_comments.json()
                    com = 0

                    # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ —Ç–µ–∫—É—â–µ–º –ø–æ—Å—Ç–µ
                    comments_from_post = k1['response']['count']

                    # –†–∞—Å–ø–∞—Ä—Å–∏–º –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞
                    while com < comments_from_post:

                        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                        dict = k1['response']['items'][com]

                        # –£–¥–∞–ª—è–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è
                        if 'attachments' in dict.keys():
                            del dict['attachments']

                        # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ª–æ–≤–∞—Ä—å –µ—â–µ –æ–¥–∏–Ω –∫–ª—é—á, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ç–µ–∫—É—â–∏–º —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                        dict['group'] = group

                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Ñ–∞–π–ª–µ —Å —Ä–∞–Ω–µ–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
                        result = str(dict) in data

                        # –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–µ—Ç - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º
                        if not result:## –ë—ã–ª–æ if result == False:
                            f.write(str(dict) + '\n')

                            # –ü–æ–ª—É—á–∞–µ–º id –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, —Ç–µ–∫—Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                            com_id = k1['response']['items'][com]['id']
                            com_text = k1['response']['items'][com]['text']
                            com_date = k1['response']['items'][com]['date']

                            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –¢–ì –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                            tg_message(CHAT_ID_TG, group, post_id, com_id, com_text, com_date, TOKEN_TG)

                            # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–æ–≤–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                            f1.write('–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ' + str(dict) + '\n')
                            com += 1
                        else:
                            # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                            f1.write('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ' + str(dict) + '\n')
                            com += 1

                # –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π - —Å—á–µ—Ç—á–∏–∫ +1
                # –ï—Å–ª–∏ –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã - —Å—á–µ—Ç—á–∏–∫ +1
                post_number += 1

    except Exception as exc:

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –ª–æ–≥-—Ñ–∞–π–ª
        f1.write('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ : ' + now.strftime('%d-%m-%Y %H:%M') + str(exc))

    # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥
    f1.write('–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω ' + now.strftime('%d-%m-%Y %H:%M') + '\n')

    # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
    f.close()
    f1.close()